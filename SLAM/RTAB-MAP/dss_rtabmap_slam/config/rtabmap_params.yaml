# RTAB-Map Configuration for DSS Platform (Livox MID-360)

rtabmap:
  ros__parameters:
    # Frame IDs
    frame_id: "base_link"
    map_frame_id: "map"
    odom_frame_id: "odom"

    # Input topics
    subscribe_depth: false
    subscribe_rgb: false
    subscribe_scan_cloud: true
    subscribe_odom_info: true

    # TF
    publish_tf: true
    wait_for_transform: 0.2

    # Synchronization
    approx_sync: false

    # Memory
    Mem/IncrementalMemory: "true"
    Mem/InitWMWithAllNodes: "false"
    Mem/STMSize: "30"

    # Registration
    Reg/Strategy: "1"  # ICP

    # ICP Parameters
    Icp/VoxelSize: "0.1"
    Icp/MaxCorrespondenceDistance: "1.0"
    Icp/PointToPlaneK: "10"
    Icp/PointToPlaneRadius: "0"
    Icp/MaxTranslation: "2.0"
    Icp/Epsilon: "0.001"
    Icp/PointToPlane: "true"
    Icp/Iterations: "10"
    Icp/CorrespondenceRatio: "0.3"

    # Odometry
    Odom/Strategy: "0"  # 0=Frame-to-Map, 1=Frame-to-Frame
    Odom/GuessMotion: "true"
    Odom/Holonomic: "false"
    OdomF2M/ScanSubtractRadius: "0.1"
    OdomF2M/ScanMaxSize: "30000"

    # Loop Closure
    RGBD/ProximityBySpace: "true"
    RGBD/ProximityMaxGraphDepth: "0"
    RGBD/ProximityPathMaxNeighbors: "10"
    RGBD/AngularUpdate: "0.1"   # rad
    RGBD/LinearUpdate: "0.3"    # m

    # Graph Optimization
    RGBD/OptimizeFromGraphEnd: "false"
    Optimizer/Epsilon: "0.00001"
    Optimizer/Iterations: "100"
    Optimizer/Slam2D: "false"

    # Grid / Map settings
    RGBD/CreateOccupancyGrid: "true"
    Grid/RangeMax: "40.0"       # Match Livox MID-360 effective range
    Grid/RangeMin: "0.5"
    Grid/FromDepth: "false"

icp_odometry:
  ros__parameters:
    frame_id: "base_link"
    odom_frame_id: "odom"
    publish_tf: true
    wait_for_transform: 0.2
    approx_sync: false

    # Scan preprocessing - CRITICAL for Livox MID-360
    scan_voxel_size: 0.1
    scan_normal_k: 10
    scan_range_min: 0.5         # Minimum range (filter close noise)
    scan_range_max: 40.0        # Maximum range (Livox MID-360 effective range)
    scan_cloud_max_points: 30000

    # Registration
    Reg/Strategy: "1"

    # ICP Odometry
    Icp/VoxelSize: "0.1"
    Icp/MaxCorrespondenceDistance: "2.0"
    Icp/PointToPlaneK: "10"
    Icp/PointToPlaneRadius: "0"
    Icp/MaxTranslation: "5.0"
    Icp/MaxRotation: "0.78"     # 45 degrees
    Icp/Epsilon: "0.001"
    Icp/PointToPlane: "true"
    Icp/Iterations: "30"
    Icp/CorrespondenceRatio: "0.3"

    Odom/Strategy: "0"
    Odom/GuessMotion: "true"
    Odom/Holonomic: "false"
    Odom/FillInfoData: "true"
    OdomF2M/ScanSubtractRadius: "0.1"
    OdomF2M/ScanMaxSize: "30000"
